<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>EMA Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.js'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

        .dropdown-inverse {
          overflow-x: hidden;
          max-height: 200px;
          height: auto;
          background: '#ff4b1f';
        }
        .mapboxgl-popup {
          position: absolute;
          top: 0;
          left: 0;
          font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }

        .btn-group {

          margin-left: 20px;
          display: inline-block;
          border-radius: 2px;
          background: '#ff4b1f';

        }


        .btn btn-primary{

        display: inline-block;
        height: 28px;
        line-height: 28px;
        color: #eee;
        border-radius: 2px;
        z-index: 3;
        cursor: pointer;
        font-weight: 600;
        font-family: 'Open Sans', sans-serif;
        padding: 5px 10px;
        margin-left: 20px;
        background: '#ff4b1f';

        }

        .dropdown-toggle{

          border-radius: 5px;
          background: '#ff4b1f';
        }

        #header {
          position: absolute;
          z-index: 1012022;
          top: 0px;
          width: 100%;
          line-height: 50px;
          height: 50px;
          background: rgba(12, 12, 12, 0.8);
          color: #eee;
        }

</style>
</head>
<body>

  <div id='map'></div>
    <div id='header'>
    <div class="btn-group">
      <i class="dropdown-arrow dropdown-arrow-inverse"></i>
      <button class="btn btn-primary">EMA Programs</button>
      <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu dropdown-inverse">
        <li><a href="#link">ALL</a></li>
        <li><a href="#link">4CITIES</a></li>
        <li><a href="#link">ACES</a></li>
        <li><a href="#link">ADVANCES</a></li>
        <li><a href="#link">AMASE</a></li>
        <li><a href="#link">ARCHMAT</a></li>
        <li><a href="#link">ASC</a></li>
        <li><a href="#link">ASTROMUNDUS</a></li>
        <li><a href="#link">ATOMSIM</a></li>
        <li><a href="#link">BIFTEC</a></li>
        <li><a href="#link">CARTO</a></li>
        <li><a href="#link">ChIR</a></li>
        <li><a href="#link">CHOREOMUNDUS</a></li>
        <li><a href="#link">CLE</a></li>
        <li><a href="#link">CoDe</a></li>
        <li><a href="#link">CoMEM</a></li>
        <li><a href="#link">COSI</a></li>
        <li><a href="#link">CWCN</a></li>
        <li><a href="#link">DCLead</a></li>
        <li><a href="#link">DESEM</a></li>
        <li><a href="#link">Dyclam</a></li>
        <li><a href="#link">EACH</a></li>
        <li><a href="#link">EDAMUS</a></li>
        <li><a href="#link">EM HRPP</a></li>
        <li><a href="#link">EMARO +</a></li>
        <li><a href="#link">EMECC NURSING</a></li>
        <li><a href="#link">EMERALD</a></li>
        <li><a href="#link">EMGS</a></li>
      </ul>
    </div>
  </div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiaXNrYW5kYXJibHVlIiwiYSI6ImNpazE3MTJldjAzYzZ1Nm0wdXZnMGU2MGMifQ.i3E1_b9QXJS8xXuPy3OTcg';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/iskandarblue/cixri3vlr000g2rn2z9fwknj6',
    center: [35.2551, 45.5260],
    zoom: 2.
});

function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++ ) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

var color = getRandomColor()

console.log(color);

map.on('style.load', function (e) {
    map.addSource('uni', {
        "type": 'geojson',
        "data": './master_points.geojson'
    });


map.addSource('cluster', {
  'type': 'geojson',
  'data': './master_points.geojson',
  'cluster': true,
  'clusterMaxZoom': 7, // Max zoom to cluster points on
  'clusterRadius': 50
});

map.addLayer({
    "id": "unclustered-points",
    "type": "symbol",
    "source": "cluster",
    "filter": ["!has", "point_count"],
    "layout": {
        "icon-image": "placeMarker",
        "icon-offset": [0, -15]
    }
});




var layers = [
    [10, '#ff4b1f'],
    [5, '#F0F564'],
    [0, '#1fddff']
];

layers.forEach(function (layer, i) {
    map.addLayer({
        "id": "cluster-" + i,
        "type": "circle",
        "source": "cluster",
        "paint": {
            "circle-color": layer[1],
            "circle-radius": 18,
            "circle-opacity": 0.9
        },
        "filter": i === 0 ?
            [">=", "point_count", layer[0]] :
            ["all",
                [">=", "point_count", layer[0]],
                ["<", "point_count", layers[i - 1][0]]]
    });
});

// Add a layer for the clusters' count labels
map.addLayer({
    "id": "cluster-count",
    "type": "symbol",
    "source": "cluster",
    "layout": {
        "text-field": "{point_count}",
        "text-font": [
            "DIN Offc Pro Medium",
            "Arial Unicode MS Bold"
        ],
        "text-size": 12
    }
});

    map.addLayer({
        "id": "uni",
        "type": "symbol",
        "source": "uni",
        "layout":{

          "visibility": "none",
          "icon-image": "marker-15",
          "icon-offset": [0, -11.5]
        }

  });
});

$(function(){

    $(".dropdown-menu li a").click(function(){

      $(".btn:first-child").text($(this).text());
      $(".btn:first-child").val($(this).text());

   });

});


$().ready(function(){
    $('a').click(function(){
        var value = $(this).text();
        console.log(value);

 if (value !== "ALL"){
        popup.remove();
        map.setLayoutProperty('uni','visibility', 'visible');
        map.setFilter('uni', ['==', 'code', value]);
      } else {



      }

/*
    // Add a layer for this symbol type if it hasn't been added already.
    if (!map.getLayer(layerID)) {
        map.addLayer({
            "id": layerID,
            "type": "circle", #1fddff
            "source": "uni",#ff4b1f
            "paint": {
                "circle-color": "#F0F564",
            },
            "filter": ["==", "code", symbol]
        });
      }
    */
    });
  });

  map.on('click', function (e) {
      var cluster_features = map.queryRenderedFeatures(e.point, {
          layers: [
              'cluster-0',
              'cluster-1',
              'cluster-2'
          ]
      });
      var cluster_feature = cluster_features[0];
      if (cluster_feature && cluster_feature.properties.cluster) {
          map.jumpTo({
              center: e.lngLat,
              zoom: map.getZoom() + 1
          });
      }
  });

  var popup = new mapboxgl.Popup({
      closeButton: true,
      closeOnClick: true
  });

  map.on('mousemove', function(e) {
      var features = map.queryRenderedFeatures(e.point, {
        layers: [

          'uni',
          'cluster-0',
          'cluster-1',
          'cluster-2'

        ] });
      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

      console.log(features[0].properties)

      console.log(features.length);

     if (!features.length) {
          popup.remove();
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      popup.setLngLat([features[0].properties.lon, features[0].properties.lat])
          .setHTML(features[0].properties.title + '<div>' + '<a href="' + features[0].properties.website +'">website</a>' + '</div>')
          .addTo(map);
  });


</script>

</body>
</html>
